<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ï–°–ö–î –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg: #0b1020;
      --surface: rgba(255,255,255,.06);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --border: rgba(255,255,255,.10);
      --primary: #6d7cff;
      --primary-2: #8b5cf6;
      --good: #22c55e;
      --bad: #ef4444;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height:1.5;
      -webkit-font-smoothing: antialiased;
    }

    .app-container{ min-height:100vh; display:flex; justify-content:center; }
    .chat-card{ width:100%; max-width:560px; min-height:100vh; display:flex; flex-direction:column; }

    .chat-header{
      padding:16px 16px 10px;
      position:sticky;
      top:0;
      z-index:5;
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,0));
      backdrop-filter: blur(10px);
    }
    .header-content{
      display:flex; align-items:center; gap:12px;
      padding:12px;
      border:1px solid var(--border);
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .logo-container{
      width:40px; height:40px;
      border-radius:12px; overflow:hidden; flex-shrink:0;
      border:1px solid var(--border);
      background: rgba(0,0,0,.2);
    }
    .logo-img{ width:100%; height:100%; object-fit:cover; display:block; }
    .header-title{ font-size:16px; font-weight:750; letter-spacing:.2px; }
    .header-subtitle{ font-size:12px; color: var(--muted); margin-top:2px; }

    .limit-container{
      margin:10px 16px 0;
      padding:12px;
      border-radius: var(--radius);
      border:1px solid var(--border);
      background: var(--surface);
    }
    .limit-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .limit-label{
      font-size:12px; color: var(--muted);
      letter-spacing:.08em; text-transform:uppercase;
      font-weight:650;
    }
    .limit-count{ font-size:12px; color: var(--text); font-weight:650; }

    .progress-bar{
      height:8px;
      background: rgba(0,0,0,.25);
      border:1px solid var(--border);
      border-radius: 999px;
      overflow:hidden;
    }
    .progress-fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--good), #f59e0b, #f97316, var(--bad));
      transition: width .25s ease;
    }

    .limit-text{ margin-top:8px; font-size:12px; color: var(--muted); }
    .limit-warning{ color: rgba(255,255,255,.72); }
    .limit-paywall{ color: #fecaca; }

    .premium-badge{ margin-top:8px; font-size:12px; color: #bbf7d0; }

    .buy-button-small, .buy-button-big{
      margin-top:10px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:10px 14px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      color:white;
      font-size:13px;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
    }
    .buy-button-small:disabled, .buy-button-big:disabled{ opacity:.6; cursor:not-allowed; }

    .messages-container{
      flex:1;
      padding:14px 16px 10px;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .system-message{
      align-self:center;
      max-width:92%;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size:12px;
      text-align:center;
    }

    .message-row{ display:flex; }
    .message-row.user{ justify-content:flex-end; }

    .message-bubble{
      max-width: 88%;
      padding:12px 12px;
      border-radius: 18px;
      font-size:14px;
      white-space:pre-wrap;
      word-wrap:break-word;
      border:1px solid var(--border);
    }

    .message-bubble.user{
      background: linear-gradient(135deg, rgba(109,124,255,.95), rgba(139,92,246,.9));
      border-color: rgba(255,255,255,.16);
    }
    .message-bubble.assistant{
      background: rgba(0,0,0,.20);
    }

    .typing-indicator{ display:inline-flex; gap:6px; align-items:center; }
    .typing-dot{
      width:6px; height:6px; border-radius:999px;
      background: rgba(255,255,255,.55);
      animation: bounce 1.2s infinite ease-in-out;
    }
    .typing-dot:nth-child(2){ animation-delay:.12s; }
    .typing-dot:nth-child(3){ animation-delay:.24s; }
    @keyframes bounce{ 0%,80%,100%{ transform:translateY(0); opacity:.45 } 40%{ transform:translateY(-3px); opacity:1 } }

    .input-container{
      position:sticky;
      bottom:0;
      padding:10px 16px 16px;
      background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.45));
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(255,255,255,.06);
    }

    .input-form{
      display:flex;
      gap:10px;
      align-items:flex-end;
      padding:10px;
      border-radius: var(--radius);
      border:1px solid var(--border);
      background: var(--surface);
      box-shadow: var(--shadow);
    }

    .text-input{
      flex:1;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px;
      resize:none;
      min-height:40px;
      max-height:130px;
      line-height:1.4;
    }
    .text-input::placeholder{ color: rgba(255,255,255,.45); }
    .text-input:disabled{ opacity:.7; }

    .send-button{
      width:44px; height:44px;
      border:none;
      border-radius:999px;
      background: linear-gradient(135deg, var(--good), #16a34a);
      color:white;
      cursor:pointer;
      font-size:16px;
      font-weight:800;
      flex-shrink:0;
      box-shadow: 0 12px 28px rgba(0,0,0,.35);
    }
    .send-button:disabled{ opacity:.6; cursor:not-allowed; }

    .footer-note{
      margin-top:10px;
      font-size:11px;
      color: var(--muted);
      text-align:center;
    }

    .error-message{
      margin-top:8px;
      min-height:16px;
      text-align:center;
      font-size:12px;
      color:#fecaca;
    }

    .limit-reached-container{
      margin:12px 16px 16px;
      padding:16px;
      border-radius: var(--radius);
      border:1px solid rgba(239,68,68,.25);
      background: rgba(239,68,68,.08);
      text-align:center;
    }
    .limit-reached-icon{ font-size:34px; }
    .limit-reached-title{ margin-top:6px; font-size:16px; font-weight:800; color:#fecaca; }
    .limit-reached-subtitle{ margin-top:6px; font-size:13px; color: var(--muted); }

    /* —Ç–æ–Ω–∫–∏–π —Å–∫—Ä–æ–ª–ª */
    .messages-container::-webkit-scrollbar{ width:4px; }
    .messages-container::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.18); border-radius: 999px; }
  </style>
</head>
<body>
<div class="app-container">
  <div class="chat-card">
    <header class="chat-header">
      <div class="header-content">
        <div class="logo-container">
          <img src="/logo.png" alt="–ï–°–ö–î –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç" class="logo-img" />
        </div>
        <div style="flex:1; display:flex; flex-direction:column;">
          <div class="header-title">–ï–°–ö–î –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</div>
          <div class="header-subtitle" id="header-subtitle">–¢–≤–æ–π –≥–∏–¥ –ø–æ –ì–û–°–¢–∞–º –∏ —á–µ—Ä—Ç–µ–∂–∞–º</div>
        </div>
      </div>
    </header>

    <div class="limit-container">
      <div class="limit-header">
        <span class="limit-label" id="limit-label">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è</span>
        <span class="limit-count"><span id="used">0</span>/<span id="limit">3</span></span>
      </div>

      <div class="progress-bar">
        <div class="progress-fill" id="limit-progress-inner" style="width: 0%"></div>
      </div>

      <div class="limit-text limit-warning" id="limit-warning">
        –û—Å—Ç–∞–ª–æ—Å—å <span id="remaining">3</span> –æ–±—Ä–∞—â–µ–Ω–∏—è
      </div>
      <div class="limit-text limit-paywall" id="limit-warning-paywall" style="display:none">
        –õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω ‚Äî –æ—Ñ–æ—Ä–º–∏—Ç–µ –ø—Ä–µ–º–∏—É–º, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.
      </div>

      <div class="premium-badge" id="premium-badge" style="display:none"></div>

      <button class="buy-button-small" id="buy-small" type="button" style="display:none">
        ‚≠ê –ü—Ä–µ–º–∏—É–º –Ω–∞ –º–µ—Å—è—Ü ‚Äî 129 –∑–≤—ë–∑–¥
      </button>
    </div>

    <div class="messages-container" id="messages">
      <div class="system-message">
        –°–ø—Ä–æ—Å–∏ –ø—Ä–æ —Ñ–æ—Ä–º–∞—Ç—ã –ª–∏—Å—Ç–æ–≤, —Ä–∞–º–∫–∏, –æ—Å–Ω–æ–≤–Ω—É—é –Ω–∞–¥–ø–∏—Å—å, —Ä–∞–∑–º–µ—Ä—ã, –¥–æ–ø—É—Å–∫–∏ –∏–ª–∏ –ø—Ä–æ –ì–û–°–¢—ã –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç/—É–ø–∞–∫–æ–≤–∫—É ‚Äî –ø–æ–º–æ–≥—É –∏ —É—Ç–æ—á–Ω—é –¥–µ—Ç–∞–ª–∏.
      </div>
    </div>

    <div class="input-container" id="input-container">
      <form class="input-form" id="chat-form">
        <textarea
          id="chat-input"
          class="text-input"
          placeholder="–ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å‚Ä¶ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–º–∞–π–æ–Ω–µ–∑¬ª –∏–ª–∏ ¬´–æ—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–¥–ø–∏—Å—å –ê3¬ª)"
          autocomplete="off"
          rows="1"
        ></textarea>
        <button class="send-button" id="send-btn" type="submit" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
      </form>
      <div class="footer-note">
        –û—Ç–≤–µ—Ç—ã —Å–ø—Ä–∞–≤–æ—á–Ω—ã–µ ‚Äî –ø–µ—Ä–µ–¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Å–≤–µ—Ä—è–π—Ç–µ—Å—å —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º–∏ —Ç–µ–∫—Å—Ç–∞–º–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤.
      </div>
      <div class="error-message" id="error"></div>
    </div>

    <div class="limit-reached-container" id="limit-reached-container" style="display:none">
      <div class="limit-reached-icon">üö´</div>
      <div class="limit-reached-title">–õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω</div>
      <div class="limit-reached-subtitle">
        –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å.<br/>
        –û—Ñ–æ—Ä–º–∏—Ç–µ –ø—Ä–µ–º–∏—É–º –∏ –∑–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.
      </div>
      <button class="buy-button-big" id="buy-big" type="button">
        ‚≠ê –ü—Ä–µ–º–∏—É–º –Ω–∞ –º–µ—Å—è—Ü ‚Äî 129 –∑–≤—ë–∑–¥
      </button>
    </div>
  </div>
</div>

<script>
  const messagesEl = document.getElementById("messages");
  const formEl = document.getElementById("chat-form");
  const inputEl = document.getElementById("chat-input");
  const sendBtn = document.getElementById("send-btn");
  const errorEl = document.getElementById("error");
  const inputContainer = document.getElementById("input-container");
  const limitReachedContainer = document.getElementById("limit-reached-container");
  const buySmallBtn = document.getElementById("buy-small");
  const buyBigBtn = document.getElementById("buy-big");
  const premiumBadgeEl = document.getElementById("premium-badge");
  const headerSubtitleEl = document.getElementById("header-subtitle");
  const limitLabelEl = document.getElementById("limit-label");

  const usedEl = document.getElementById("used");
  const limitEl = document.getElementById("limit");
  const remEl = document.getElementById("remaining");
  const progressInner = document.getElementById("limit-progress-inner");
  const limitWarningEl = document.getElementById("limit-warning");
  const limitPaywallEl = document.getElementById("limit-warning-paywall");

  let telegramId = null;
  let messagesUsed = 0;
  let freeLimit = 3;
  let isPremium = false;
  let premiumUntil = null;
  let isSending = false;
  let limitReached = false;
  let isBuying = false;

  function scrollToBottom() {
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function appendMessage(role, content) {
    const row = document.createElement("div");
    row.className = "message-row " + role;

    const bubble = document.createElement("div");
    bubble.className = "message-bubble " + (role === "user" ? "user" : "assistant");
    bubble.textContent = content;

    row.appendChild(bubble);
    messagesEl.appendChild(row);
    scrollToBottom();
  }

  function appendTyping() {
    const row = document.createElement("div");
    row.className = "message-row assistant";
    row.id = "typing-row";

    const bubble = document.createElement("div");
    bubble.className = "message-bubble assistant";

    const ti = document.createElement("div");
    ti.className = "typing-indicator";
    ti.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';

    bubble.appendChild(ti);
    row.appendChild(bubble);

    messagesEl.appendChild(row);
    scrollToBottom();
  }

  function removeTyping() {
    const row = document.getElementById("typing-row");
    if (row && row.parentNode) row.parentNode.removeChild(row);
  }

  function formatDateDDMMYY(iso) {
    const d = new Date(iso);
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = String(d.getFullYear()).slice(-2);
    return `${dd}.${mm}.${yy}`;
  }

  function updatePremiumUI() {
    if (isPremium && premiumUntil) {
      const dt = formatDateDDMMYY(premiumUntil);
      headerSubtitleEl.textContent = `–ü—Ä–µ–º–∏—É–º –¥–æ ${dt}`;
      limitLabelEl.textContent = "–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø";
      premiumBadgeEl.style.display = "block";
      premiumBadgeEl.textContent = `–ü—Ä–µ–º–∏—É–º –∞–∫—Ç–∏–≤–µ–Ω –¥–æ ${dt}`;

      limitWarningEl.style.display = "none";
      limitPaywallEl.style.display = "none";
      buySmallBtn.style.display = "none";
      limitReachedContainer.style.display = "none";
      inputContainer.style.display = "block";

      usedEl.textContent = "‚àû";
      limitEl.textContent = "‚àû";
      remEl.textContent = "‚àû";
      progressInner.style.width = "0%";
    } else {
      headerSubtitleEl.textContent = "–¢–≤–æ–π –≥–∏–¥ –ø–æ –ì–û–°–¢–∞–º –∏ —á–µ—Ä—Ç–µ–∂–∞–º";
      limitLabelEl.textContent = "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è";
      premiumBadgeEl.style.display = "none";
      usedEl.textContent = messagesUsed;
      limitEl.textContent = freeLimit;
    }
  }

  function updateLimitUI() {
    if (isPremium) { updatePremiumUI(); return; }

    usedEl.textContent = messagesUsed;
    limitEl.textContent = freeLimit;
    const remaining = Math.max(0, freeLimit - messagesUsed);
    remEl.textContent = remaining;

    const percent = freeLimit > 0 ? Math.min(100, (messagesUsed / freeLimit) * 100) : 0;
    progressInner.style.width = percent + "%";

    limitReached = messagesUsed >= freeLimit;
    if (limitReached) {
      limitWarningEl.style.display = "none";
      limitPaywallEl.style.display = "block";
      inputEl.disabled = true;
      sendBtn.disabled = true;
      inputContainer.style.display = "none";
      limitReachedContainer.style.display = "block";
      buySmallBtn.style.display = "none";
    } else {
      limitWarningEl.style.display = "block";
      limitPaywallEl.style.display = "none";
      inputEl.disabled = false;
      sendBtn.disabled = false;
      inputContainer.style.display = "block";
      limitReachedContainer.style.display = "none";
      buySmallBtn.style.display = "inline-flex";
    }
  }

  function initTelegramId() {
    try {
      const tg = window.Telegram && window.Telegram.WebApp;
      if (tg) {
        tg.ready();
        tg.expand();

        // –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥ —Ç–µ–º—É Telegram
        const p = tg.themeParams || {};
        if (p.bg_color) document.documentElement.style.setProperty('--bg', p.bg_color);
        if (p.text_color) document.documentElement.style.setProperty('--text', p.text_color);
        if (p.hint_color) document.documentElement.style.setProperty('--muted', p.hint_color);

        const user = tg.initDataUnsafe && tg.initDataUnsafe.user;
        const id = (user && user.id) || null;
        telegramId = id ? String(id) : "anon-" + Math.random().toString(36).slice(2, 10);
      } else {
        let storedId = null;
        try {
          storedId = localStorage.getItem('eskd_dev_id');
          if (!storedId) {
            storedId = 'local-' + Math.random().toString(36).slice(2, 10);
            localStorage.setItem('eskd_dev_id', storedId);
          }
        } catch (e) {
          storedId = 'local-' + Math.random().toString(36).slice(2, 10);
        }
        telegramId = storedId;
      }
    } catch (e) {
      console.error("Telegram init error", e);
      telegramId = "fallback-user";
    }
  }

  async function loadUserInfo() {
    if (!telegramId) return;
    try {
      const res = await fetch("/api/user", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ telegramId })
      });
      if (!res.ok) return;
      const data = await res.json();

      messagesUsed = data.messages_used ?? 0;
      freeLimit = data.free_limit ?? 3;
      isPremium = !!data.is_premium;
      premiumUntil = data.premium_until || null;

      if (isPremium) {
        updatePremiumUI();
      } else {
        buySmallBtn.style.display = "inline-flex";
        updateLimitUI();
      }
    } catch (e) {
      console.error("loadUserInfo error", e);
    }
  }

  inputEl.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
  });

  formEl.addEventListener("submit", async (e) => {
    e.preventDefault();
    errorEl.textContent = "";

    const text = inputEl.value.trim();
    if (!text || isSending || (!isPremium && limitReached) || !telegramId) return;

    appendMessage("user", text);
    inputEl.value = "";
    inputEl.style.height = 'auto';

    isSending = true;
    sendBtn.disabled = true;
    appendTyping();

    try {
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ telegramId, message: text })
      });

      removeTyping();

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        if (res.status === 403 && err.error && err.error.message === "limit_reached") {
          messagesUsed = err.messages_used ?? messagesUsed;
          freeLimit = err.free_limit ?? freeLimit;
          isPremium = !!err.is_premium;
          updateLimitUI();
          errorEl.textContent = err.message || "–õ–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –∏—Å—á–µ—Ä–ø–∞–Ω.";
          return;
        }
        errorEl.textContent = (err.error && err.error.message) || err.error || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä—É.";
        return;
      }

      const data = await res.json();
      if (data.ok === false) {
        errorEl.textContent = (data.error && data.error.message) || "–û—à–∏–±–∫–∞.";
        return;
      }

      messagesUsed = data.messages_used ?? messagesUsed;
      freeLimit = data.free_limit ?? freeLimit;
      isPremium = !!data.is_premium;
      premiumUntil = data.premium_until || premiumUntil;

      if (isPremium) updatePremiumUI();
      else updateLimitUI();

      appendMessage("assistant", data.answer || "–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.");
    } catch (err) {
      console.error("send error", err);
      removeTyping();
      errorEl.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.";
    } finally {
      isSending = false;
      if (!limitReached || isPremium) sendBtn.disabled = false;
    }
  });

  async function handleBuyClick() {
    errorEl.textContent = "";
    if (!telegramId) {
      errorEl.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å Telegram ID.";
      return;
    }

    const tg = window.Telegram && window.Telegram.WebApp;
    if (!tg || !tg.openInvoice) {
      alert("–ü–æ–∫—É–ø–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram.");
      return;
    }

    if (isBuying) return;
    isBuying = true;
    buySmallBtn.disabled = true;
    buyBigBtn.disabled = true;

    try {
      const res = await fetch("/api/pay-stars", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ telegramId })
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        console.error("pay-stars error", err);
        errorEl.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –æ–ø–ª–∞—Ç—É.";
        return;
      }

      const data = await res.json();
      const invoiceUrl = data.invoice_url;
      if (!invoiceUrl) {
        errorEl.textContent = "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á—ë—Ç–∞.";
        return;
      }

      tg.openInvoice(invoiceUrl, async (status) => {
        console.log("invoice status:", status);

        if (status === "paid") {
          // –í–ê–ñ–ù–û: –ø—Ä–µ–º–∏—É–º –≤–∫–ª—é—á–∞–µ—Ç—Å—è –≤–µ–±—Ö—É–∫–æ–º /api/tg-webhook.js
          errorEl.textContent = "–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞. –û–±–Ω–æ–≤–ª—è—é —Å—Ç–∞—Ç—É—Å‚Ä¶";
          setTimeout(loadUserInfo, 1200);
        } else if (status === "cancelled") {
          errorEl.textContent = "–û–ø–ª–∞—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.";
        } else if (status === "failed") {
          errorEl.textContent = "–û–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.";
        }
      });
    } catch (e) {
      console.error("buy error", e);
      errorEl.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–∫—É–ø–∫—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.";
    } finally {
      isBuying = false;
      buySmallBtn.disabled = false;
      buyBigBtn.disabled = false;
    }
  }

  buySmallBtn.addEventListener("click", handleBuyClick);
  buyBigBtn.addEventListener("click", handleBuyClick);

  initTelegramId();
  updateLimitUI();
  loadUserInfo();
</script>
</body>
</html>
