<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>ЕСКД Ассистент</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #0b1220;
      --surface: rgba(255,255,255,.06);
      --surface2: rgba(255,255,255,.09);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.60);
      --line: rgba(255,255,255,.08);

      --blue: #2b7cff;
      --green: #22c55e;
      --red: #ef4444;
      --amber: #f59e0b;

      --r12: 12px;
      --r16: 16px;
      --r20: 20px;

      --shadow: 0 12px 30px rgba(0,0,0,.28);
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    body{
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.45;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    /* Subtle background */
    body::before{
      content:"";
      position: fixed;
      inset: -30%;
      z-index:-1;
      background:
        radial-gradient(circle at 15% 20%, rgba(43,124,255,.18), transparent 52%),
        radial-gradient(circle at 85% 10%, rgba(34,197,94,.12), transparent 55%),
        radial-gradient(circle at 30% 90%, rgba(139,92,246,.14), transparent 55%);
      filter: blur(18px);
      opacity: .9;
    }

    .app{
      height: 100vh;
      display:flex;
      flex-direction: column;
    }

    /* Header */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 12px 14px 10px;
      background: linear-gradient(180deg, rgba(11,18,32,.92), rgba(11,18,32,.65));
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .logo{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      overflow:hidden;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.08);
      flex-shrink:0;
    }
    .logo img{ width:100%; height:100%; object-fit:cover; display:block; }

    .brandText{
      flex:1;
      display:flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .title{
      font-size: 15px;
      font-weight: 800;
      letter-spacing: .2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .subtitle{
      font-size: 12px;
      color: var(--muted);
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Status row (compact, modern) */
    .statusRow{
      margin-top: 10px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: var(--r16);
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.06);
    }

    .statusLeft{
      min-width: 0;
      display:flex;
      flex-direction: column;
      gap: 3px;
    }

    .statusLabel{
      font-size: 11px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: rgba(255,255,255,.55);
      font-weight: 800;
    }

    .statusValue{
      font-size: 12px;
      color: rgba(255,255,255,.80);
      font-weight: 650;
    }

    .statusRight{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-shrink:0;
    }

    .pill{
      font-size: 12px;
      font-weight: 800;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.85);
    }

    .pill.good{
      border-color: rgba(34,197,94,.30);
      background: rgba(34,197,94,.12);
      color: #bbf7d0;
    }

    .pill.bad{
      border-color: rgba(239,68,68,.30);
      background: rgba(239,68,68,.12);
      color: #fecaca;
    }

    .buySmall{
      border: none;
      border-radius: 999px;
      padding: 9px 12px;
      font-weight: 900;
      font-size: 12px;
      background: rgba(43,124,255,.95);
      color: white;
      box-shadow: var(--shadow);
      cursor: pointer;
    }
    .buySmall:disabled{ opacity:.6; cursor:not-allowed; box-shadow:none; }

    /* Chips: modern */
    .chips{
      margin-top: 10px;
      display:flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 2px;
      -webkit-overflow-scrolling: touch;
    }
    .chips::-webkit-scrollbar{ display:none; }

    .chip{
      flex-shrink:0;
      border-radius: 999px;
      padding: 9px 12px;
      font-size: 12px;
      font-weight: 750;
      color: rgba(255,255,255,.85);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
    }
    .chip:active{ transform: translateY(1px); }

    /* Messages */
    .messages{
      flex:1;
      overflow-y:auto;
      padding: 14px 14px 10px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .messages::-webkit-scrollbar{ width:4px; }
    .messages::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.14); border-radius: 999px; }

    .sys{
      align-self:center;
      max-width: 94%;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.08);
      color: var(--muted);
      font-size: 12px;
      text-align:center;
    }

    .row{ display:flex; }
    .row.user{ justify-content:flex-end; }

    .bubble{
      max-width: 88%;
      padding: 12px 12px;
      border-radius: var(--r20);
      font-size: 14px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .bubble.user{
      background: rgba(43,124,255,.92);
      color: white;
      border-bottom-right-radius: 10px;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }

    .bubble.assistant{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.08);
      color: rgba(255,255,255,.92);
      border-bottom-left-radius: 10px;
    }

    .typing{
      display:inline-flex;
      gap: 6px;
      align-items:center;
    }
    .dot{
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,.55);
      animation: bounce 1.2s infinite ease-in-out;
    }
    .dot:nth-child(2){ animation-delay:.12s; }
    .dot:nth-child(3){ animation-delay:.24s; }
    @keyframes bounce{
      0%,80%,100%{ transform:translateY(0); opacity:.45 }
      40%{ transform:translateY(-3px); opacity:1 }
    }

    /* Composer */
    .composerWrap{
      position: sticky;
      bottom: 0;
      z-index: 10;
      padding: 10px 14px 16px;
      background: linear-gradient(180deg, rgba(11,18,32,0), rgba(11,18,32,.92));
      backdrop-filter: blur(12px);
      border-top: 1px solid rgba(255,255,255,.06);
    }

    .composer{
      display:flex;
      gap: 10px;
      align-items:flex-end;
      padding: 10px;
      border-radius: var(--r20);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
    }

    textarea{
      flex: 1;
      border: none;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size: 14px;
      resize:none;
      min-height: 40px;
      max-height: 120px;
      line-height: 1.35;
    }
    textarea::placeholder{ color: rgba(255,255,255,.45); }
    textarea:disabled{ opacity:.65; }

    .send{
      width: 46px;
      height: 46px;
      border-radius: 999px;
      border: none;
      background: rgba(34,197,94,.96);
      color:white;
      font-size: 16px;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 12px 24px rgba(0,0,0,.28);
    }
    .send:disabled{ opacity:.6; cursor:not-allowed; box-shadow:none; }

    .foot{
      margin-top: 10px;
      text-align:center;
      font-size: 11px;
      color: var(--muted);
    }
    .error{
      margin-top: 8px;
      min-height: 16px;
      text-align:center;
      font-size: 12px;
      color: #fecaca;
    }

    /* Paywall sheet */
    .paywall{
      margin-top: 10px;
      padding: 12px 12px;
      border-radius: var(--r16);
      border: 1px solid rgba(239,68,68,.20);
      background: rgba(239,68,68,.08);
      display:none;
      text-align:center;
    }
    .payTitle{ font-weight: 900; color: #fecaca; font-size: 13px; }
    .payText{ margin-top: 6px; font-size: 12px; color: var(--muted); }
    .buyBig{
      margin-top: 10px;
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 12px 14px;
      font-weight: 900;
      font-size: 13px;
      background: rgba(43,124,255,.95);
      color:white;
      cursor:pointer;
      box-shadow: var(--shadow);
    }
    .buyBig:disabled{ opacity:.6; cursor:not-allowed; box-shadow:none; }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo"><img src="/logo.png" alt="logo"></div>
        <div class="brandText">
          <div class="title">ЕСКД Ассистент</div>
          <div class="subtitle" id="header-subtitle">Эксперт по ЕСКД / ГОСТ / маркировке</div>
        </div>
      </div>

      <div class="statusRow">
        <div class="statusLeft">
          <div class="statusLabel" id="limit-label">Бесплатные обращения</div>
          <div class="statusValue" id="status-value">
            Использовано: <span id="used">0</span> из <span id="limit">3</span>
          </div>
        </div>

        <div class="statusRight">
          <div class="pill" id="status-pill">Осталось: <span id="remaining">3</span></div>
          <button class="buySmall" id="buy-small" type="button" style="display:none">⭐ 129</button>
        </div>
      </div>

      <div class="chips" id="chips">
        <div class="chip" data-text="Салфетки — маркировка для ЕАЭС. Что обязательно на упаковке? Сначала уточни тип салфеток и назначение.">Салфетки</div>
        <div class="chip" data-text="Майонез — маркировка для ЕАЭС. Что обязательно на этикетке?">Майонез</div>
        <div class="chip" data-text="ЕСКД — рамка и основная надпись. Формат А3. Дай алгоритм и ГОСТы.">Рамка/штамп</div>
        <div class="chip" data-text="ЕСКД — шрифты на чертеже: высоты, применение, частые ошибки.">Шрифты</div>
        <div class="chip" data-text="ЕСКД — форматы листов А0–А4: выбор, ориентация, поля.">Форматы</div>
        <div class="chip" data-text="Маркировка товара для ЕАЭС: обязательные элементы на упаковке, порядок, типичные ошибки.">Маркировка</div>
      </div>
    </div>

    <div class="messages" id="messages">
      <div class="sys">
        Пиши как удобно. Если данных мало — уточню по делу и дам готовый алгоритм.
      </div>
    </div>

    <div class="composerWrap">
      <form class="composer" id="chat-form">
        <textarea id="chat-input" placeholder="Напиши вопрос… (например: «салфетки — маркировка ЕАЭС»)" rows="1"></textarea>
        <button class="send" id="send-btn" type="submit">➤</button>
      </form>

      <div class="paywall" id="paywall">
        <div class="payTitle">Лимит исчерпан</div>
        <div class="payText">Оформите премиум и задавайте вопросы без ограничений.</div>
        <button class="buyBig" id="buy-big" type="button">⭐ Премиум на месяц — 129 звёзд</button>
      </div>

      <div class="foot">
        Ответы справочные — перед оформлением сверяйтесь с официальными текстами.
      </div>
      <div class="error" id="error"></div>
    </div>
  </div>

<script>
  const messagesEl = document.getElementById("messages");
  const formEl = document.getElementById("chat-form");
  const inputEl = document.getElementById("chat-input");
  const sendBtn = document.getElementById("send-btn");
  const errorEl = document.getElementById("error");

  const headerSubtitleEl = document.getElementById("header-subtitle");
  const limitLabelEl = document.getElementById("limit-label");
  const usedEl = document.getElementById("used");
  const limitEl = document.getElementById("limit");
  const remEl = document.getElementById("remaining");
  const statusValueEl = document.getElementById("status-value");
  const statusPillEl = document.getElementById("status-pill");

  const buySmallBtn = document.getElementById("buy-small");
  const buyBigBtn = document.getElementById("buy-big");
  const paywallEl = document.getElementById("paywall");

  let telegramId = null;
  let messagesUsed = 0;
  let freeLimit = 3;
  let isPremium = false;
  let premiumUntil = null;

  let isSending = false;
  let isBuying = false;
  let limitReached = false;

  // умная склейка уточнений
  let pendingClarify = null; // { base: "салфетки" }

  // короткая память на клиенте
  const HISTORY_MAX = 6;
  const history = []; // {role, content}
  function pushHistory(role, content){
    history.push({ role, content });
    while (history.length > HISTORY_MAX) history.shift();
  }

  function scrollToBottom() {
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function appendMessage(role, content) {
    const row = document.createElement("div");
    row.className = "row " + role;

    const bubble = document.createElement("div");
    bubble.className = "bubble " + (role === "user" ? "user" : "assistant");
    bubble.textContent = content;

    row.appendChild(bubble);
    messagesEl.appendChild(row);
    scrollToBottom();
  }

  function appendTyping() {
    const row = document.createElement("div");
    row.className = "row assistant";
    row.id = "typing-row";

    const bubble = document.createElement("div");
    bubble.className = "bubble assistant";
    bubble.innerHTML = '<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>';

    row.appendChild(bubble);
    messagesEl.appendChild(row);
    scrollToBottom();
  }

  function removeTyping() {
    const row = document.getElementById("typing-row");
    if (row && row.parentNode) row.parentNode.removeChild(row);
  }

  function formatDateDDMMYY(iso) {
    const d = new Date(iso);
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = String(d.getFullYear()).slice(-2);
    return `${dd}.${mm}.${yy}`;
  }

  function updateUI() {
    if (isPremium && premiumUntil) {
      const dt = formatDateDDMMYY(premiumUntil);
      headerSubtitleEl.textContent = `Премиум до ${dt}`;
      limitLabelEl.textContent = "Премиум";
      statusValueEl.innerHTML = `Без ограничений`;
      usedEl.textContent = "∞";
      limitEl.textContent = "∞";
      remEl.textContent = "∞";

      statusPillEl.className = "pill good";
      statusPillEl.textContent = "Активен";

      buySmallBtn.style.display = "none";
      paywallEl.style.display = "none";

      inputEl.disabled = false;
      sendBtn.disabled = false;
      limitReached = false;
      return;
    }

    headerSubtitleEl.textContent = "Эксперт по ЕСКД / ГОСТ / маркировке";
    limitLabelEl.textContent = "Бесплатные обращения";

    usedEl.textContent = messagesUsed;
    limitEl.textContent = freeLimit;

    const remaining = Math.max(0, freeLimit - messagesUsed);
    remEl.textContent = remaining;

    statusValueEl.innerHTML = `Использовано: <span id="used">${messagesUsed}</span> из <span id="limit">${freeLimit}</span>`;

    limitReached = messagesUsed >= freeLimit;

    if (limitReached) {
      statusPillEl.className = "pill bad";
      statusPillEl.textContent = "Лимит исчерпан";
      buySmallBtn.style.display = "none";
      paywallEl.style.display = "block";
      inputEl.disabled = true;
      sendBtn.disabled = true;
    } else {
      statusPillEl.className = "pill";
      statusPillEl.textContent = `Осталось: ${remaining}`;
      buySmallBtn.style.display = "inline-block";
      paywallEl.style.display = "none";
      inputEl.disabled = false;
      sendBtn.disabled = false;
    }
  }

  function initTelegramId() {
    try {
      const tg = window.Telegram && window.Telegram.WebApp;
      if (tg) {
        tg.ready();
        tg.expand();

        // адаптация к теме Telegram
        const p = tg.themeParams || {};
        if (p.bg_color) document.documentElement.style.setProperty('--bg', p.bg_color);
        if (p.text_color) document.documentElement.style.setProperty('--text', p.text_color);
        if (p.hint_color) document.documentElement.style.setProperty('--muted', p.hint_color);

        const user = tg.initDataUnsafe && tg.initDataUnsafe.user;
        telegramId = user?.id ? String(user.id) : ("anon-" + Math.random().toString(36).slice(2, 10));
      } else {
        // dev mode
        let stored = null;
        try {
          stored = localStorage.getItem('eskd_dev_id');
          if (!stored) {
            stored = 'local-' + Math.random().toString(36).slice(2, 10);
            localStorage.setItem('eskd_dev_id', stored);
          }
        } catch(_) {
          stored = 'local-' + Math.random().toString(36).slice(2, 10);
        }
        telegramId = stored;
      }
    } catch (e) {
      console.error("Telegram init error", e);
      telegramId = "fallback-user";
    }
  }

  async function loadUserInfo() {
    if (!telegramId) return;
    try {
      const res = await fetch("/api/user", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ telegramId })
      });
      if (!res.ok) return;
      const data = await res.json();
      messagesUsed = data.messages_used ?? 0;
      freeLimit = data.free_limit ?? 3;
      isPremium = !!data.is_premium;
      premiumUntil = data.premium_until || null;
      updateUI();
    } catch (e) {
      console.error("loadUserInfo error", e);
    }
  }

  inputEl.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
  });

  function normalizeShort(text){
    const t = String(text || '').trim();
    return t.toLowerCase();
  }

  function applyClarifyGlue(userText){
    if (!pendingClarify) return userText;
    const short = normalizeShort(userText);
    const isShort = short.length <= 18 && short.split(/\s+/).filter(Boolean).length <= 2;
    if (!isShort) { pendingClarify = null; return userText; }
    const glued = `${pendingClarify.base} — ${userText}`;
    pendingClarify = null;
    return glued;
  }

  async function sendMessage(text) {
    errorEl.textContent = "";
    const clean = String(text || "").trim();
    if (!clean || isSending || (!isPremium && limitReached) || !telegramId) return;

    const finalText = applyClarifyGlue(clean);

    appendMessage("user", clean);
    pushHistory("user", finalText);

    inputEl.value = "";
    inputEl.style.height = 'auto';

    isSending = true;
    sendBtn.disabled = true;
    appendTyping();

    try {
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ telegramId, message: finalText, history })
      });

      removeTyping();

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        if (res.status === 403 && err.error && err.error.message === "limit_reached") {
          messagesUsed = err.messages_used ?? messagesUsed;
          freeLimit = err.free_limit ?? freeLimit;
          isPremium = !!err.is_premium;
          updateUI();
          errorEl.textContent = err.message || "Лимит исчерпан.";
          return;
        }
        errorEl.textContent = (err.error && err.error.message) || err.error || "Ошибка при обращении к серверу.";
        return;
      }

      const data = await res.json();
      messagesUsed = data.messages_used ?? messagesUsed;
      freeLimit = data.free_limit ?? freeLimit;
      isPremium = !!data.is_premium;
      premiumUntil = data.premium_until || premiumUntil;
      updateUI();

      const ans = data.answer || "Пустой ответ.";
      appendMessage("assistant", ans);
      pushHistory("assistant", ans);

      if (data.needs_clarification) {
        pendingClarify = { base: clean };
      } else {
        pendingClarify = null;
      }
    } catch (e) {
      console.error("send error", e);
      removeTyping();
      errorEl.textContent = "Не удалось отправить запрос. Проверьте интернет.";
    } finally {
      isSending = false;
      if (!limitReached || isPremium) sendBtn.disabled = false;
    }
  }

  formEl.addEventListener("submit", async (e) => {
    e.preventDefault();
    await sendMessage(inputEl.value);
  });

  document.getElementById("chips").addEventListener("click", (e) => {
    const chip = e.target.closest(".chip");
    if (!chip) return;
    const txt = chip.getAttribute("data-text");
    if (!txt) return;
    sendMessage(txt);
  });

  async function handleBuyClick() {
    errorEl.textContent = "";
    if (!telegramId) { errorEl.textContent = "Не удалось определить Telegram ID."; return; }

    const tg = window.Telegram && window.Telegram.WebApp;
    if (!tg || !tg.openInvoice) {
      alert("Покупка доступна только внутри Telegram.");
      return;
    }

    if (isBuying) return;
    isBuying = true;
    buySmallBtn.disabled = true;
    buyBigBtn.disabled = true;

    try {
      const res = await fetch("/api/pay-stars", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ telegramId })
      });

      if (!res.ok) {
        errorEl.textContent = "Не удалось создать оплату.";
        return;
      }

      const data = await res.json();
      const invoiceUrl = data.invoice_url;
      if (!invoiceUrl) { errorEl.textContent = "Ошибка при создании счёта."; return; }

      tg.openInvoice(invoiceUrl, async (status) => {
        if (status === "paid") {
          errorEl.textContent = "Оплата прошла. Обновляю статус…";

          let tries = 0;
          const timer = setInterval(async () => {
            tries++;
            await loadUserInfo();
            if (isPremium || tries >= 6) {
              clearInterval(timer);
              if (!isPremium) errorEl.textContent = "Оплата прошла, но статус обновляется. Откройте мини-апп заново через 10–20 секунд.";
              else errorEl.textContent = "";
            }
          }, 1100);
        } else if (status === "cancelled") {
          errorEl.textContent = "Оплата отменена.";
        } else if (status === "failed") {
          errorEl.textContent = "Оплата не прошла. Попробуйте ещё раз.";
        }
      });

    } catch (e) {
      console.error("buy error", e);
      errorEl.textContent = "Не удалось создать покупку. Проверьте интернет.";
    } finally {
      isBuying = false;
      buySmallBtn.disabled = false;
      buyBigBtn.disabled = false;
    }
  }

  buySmallBtn.addEventListener("click", handleBuyClick);
  buyBigBtn.addEventListener("click", handleBuyClick);

  initTelegramId();
  loadUserInfo();
  updateUI();
</script>
</body>
</html>
