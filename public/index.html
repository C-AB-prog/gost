<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>ЕСКД Ассистент</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Типографика (даёт сразу ощущение “современно”) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --border: rgba(255,255,255,.10);
      --shadow: 0 18px 60px rgba(0,0,0,.42);
      --radius: 18px;

      --blue: #2b7cff;
      --green: #22c55e;
      --red: #ef4444;
      --amber: #f59e0b;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body{
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    /* Layout */
    .shell{
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 18px 12px;
    }

    .app{
      width: min(1100px, 100%);
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    /* Desktop split: chat + right panel */
    @media (min-width: 980px){
      .shell{ padding: 26px 18px; }
      .app{
        grid-template-columns: 560px 1fr;
        align-items: start;
      }
    }

    /* Chat card */
    .chat{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      min-height: 86vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header{
      padding: 14px 14px 10px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0));
      border-bottom: 1px solid rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
    }
    .headerRow{
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      flex-shrink: 0;
    }
    .logo img{ width:100%; height:100%; object-fit: cover; display:block; }

    .titleBox{ display:flex; flex-direction: column; gap: 2px; flex: 1; }
    .title{
      font-size: 15px;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .subtitle{
      font-size: 12px;
      color: var(--muted);
      font-weight: 500;
    }

    /* Status strip */
    .status{
      margin-top: 10px;
      display: grid;
      gap: 8px;
      padding: 10px;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      background: var(--panel);
    }

    .statusTop{
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
    }
    .statusLabel{
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .10em;
      color: var(--muted);
      font-weight: 700;
    }
    .statusCount{
      font-size: 12px;
      font-weight: 700;
      color: rgba(255,255,255,.85);
    }

    .bar{
      height: 8px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
      overflow: hidden;
    }
    .barFill{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--green), var(--amber), #f97316, var(--red));
      transition: width .25s ease;
    }

    .statusText{
      font-size: 12px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
    }
    .premiumBadge{
      font-size: 12px;
      color: #bbf7d0;
      font-weight: 600;
      display: none;
    }

    /* Chips */
    .chips{
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .chip{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.86);
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 999px;
      cursor: pointer;
      user-select: none;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      font-weight: 600;
    }
    .chip:hover{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.16); }
    .chip:active{ transform: translateY(1px); }

    /* Messages */
    .messages{
      flex: 1;
      padding: 14px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .messages::-webkit-scrollbar{ width: 4px; }
    .messages::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.16); border-radius: 999px; }

    .sys{
      align-self: center;
      max-width: 95%;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size: 12px;
      text-align: center;
    }

    .row{ display: flex; }
    .row.user{ justify-content: flex-end; }

    .bubble{
      max-width: 88%;
      padding: 12px 12px;
      border-radius: 18px;
      font-size: 14px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .bubble.user{
      background: rgba(43,124,255,.92);
      color: white;
      border-bottom-right-radius: 8px;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }
    .bubble.assistant{
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.08);
      border-bottom-left-radius: 8px;
    }

    .typing{
      display:inline-flex; gap: 6px; align-items:center;
    }
    .dot{
      width: 6px; height: 6px; border-radius: 999px;
      background: rgba(255,255,255,.55);
      animation: bounce 1.2s infinite ease-in-out;
    }
    .dot:nth-child(2){ animation-delay: .12s; }
    .dot:nth-child(3){ animation-delay: .24s; }
    @keyframes bounce{ 0%,80%,100%{ transform:translateY(0); opacity:.45 } 40%{ transform:translateY(-3px); opacity:1 } }

    /* Composer */
    .composerWrap{
      padding: 12px 14px 14px;
      border-top: 1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.40));
      backdrop-filter: blur(10px);
    }

    .composer{
      display:flex;
      gap: 10px;
      align-items: flex-end;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: var(--panel);
      box-shadow: 0 14px 40px rgba(0,0,0,.30);
    }

    textarea{
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      color: var(--text);
      font-size: 14px;
      resize: none;
      min-height: 40px;
      max-height: 130px;
      line-height: 1.4;
    }
    textarea::placeholder{ color: rgba(255,255,255,.45); }

    .send{
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: rgba(34,197,94,.95);
      color: white;
      font-weight: 900;
      font-size: 16px;
      display: grid;
      place-items: center;
      box-shadow: 0 12px 26px rgba(0,0,0,.30);
    }
    .send:disabled{ opacity: .6; cursor: not-allowed; }

    .foot{
      margin-top: 10px;
      text-align: center;
      font-size: 11px;
      color: var(--muted);
    }

    .error{
      margin-top: 8px;
      min-height: 16px;
      text-align: center;
      font-size: 12px;
      color: #fecaca;
    }

    /* Paywall */
    .paywall{
      margin: 12px 14px 14px;
      padding: 14px;
      border-radius: 16px;
      border: 1px solid rgba(239,68,68,.22);
      background: rgba(239,68,68,.08);
      text-align: center;
      display: none;
    }
    .paywallTitle{ font-weight: 800; color: #fecaca; }
    .paywallText{ margin-top: 6px; font-size: 13px; color: var(--muted); }
    .buy{
      margin-top: 10px;
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(43,124,255,.92);
      color: white;
      font-weight: 800;
      padding: 12px 14px;
      cursor: pointer;
    }
    .buy:disabled{ opacity: .6; cursor: not-allowed; }

    /* Right panel (desktop) */
    .side{
      display: none;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    @media (min-width: 980px){
      .side{ display: block; }
    }

    .sideHeader{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0));
    }
    .sideTitle{
      font-size: 14px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .sideSub{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 500;
    }

    .sideBody{
      padding: 14px;
      display: grid;
      gap: 12px;
    }

    .card{
      border: 1px solid rgba(255,255,255,.08);
      background: var(--panel);
      border-radius: 16px;
      padding: 12px;
    }
    .cardTitle{
      font-size: 12px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .10em;
      color: var(--muted);
    }
    .cardText{
      margin-top: 8px;
      font-size: 13px;
      color: rgba(255,255,255,.88);
      line-height: 1.45;
    }

    .examples{
      display: grid;
      gap: 8px;
      margin-top: 10px;
    }
    .ex{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 12px;
      padding: 10px;
      cursor: pointer;
      transition: background .12s ease, border-color .12s ease;
      font-size: 13px;
      color: rgba(255,255,255,.88);
    }
    .ex:hover{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.16); }
  </style>
</head>

<body>
<div class="shell">
  <div class="app">
    <!-- CHAT -->
    <div class="chat">
      <div class="header">
        <div class="headerRow">
          <div class="logo"><img src="/logo.png" alt="logo"></div>
          <div class="titleBox">
            <div class="title">ЕСКД Ассистент</div>
            <div class="subtitle" id="header-subtitle">Эксперт по ЕСКД / ГОСТ / маркировке</div>
          </div>
        </div>

        <div class="status">
          <div class="statusTop">
            <div class="statusLabel" id="limit-label">Бесплатные обращения</div>
            <div class="statusCount"><span id="used">0</span>/<span id="limit">3</span></div>
          </div>

          <div class="bar"><div class="barFill" id="limit-progress-inner" style="width:0%"></div></div>

          <div class="statusText">
            <div id="limit-warning">Осталось <span id="remaining">3</span> обращения</div>
            <div class="premiumBadge" id="premium-badge"></div>
          </div>

          <button class="buy" id="buy-small" type="button" style="display:none">
            ⭐ Премиум на месяц — 129 звёзд
          </button>

          <div class="chips" id="chips">
            <div class="chip" data-text="Рамка и основная надпись (ЕСКД). Формат А3. Что нужно сделать правильно?">Рамка/штамп</div>
            <div class="chip" data-text="Шрифт на чертеже по ЕСКД: высоты, тип, применение. Дай алгоритм и ГОСТ.">Шрифты</div>
            <div class="chip" data-text="Форматы листов по ЕСКД (А0–А4): выбор, ориентация, поля.">Форматы</div>
            <div class="chip" data-text="Маркировка товара: что обязательно на упаковке для ЕАЭС. Сначала задай уточняющие вопросы.">Маркировка</div>
            <div class="chip" data-text="Салфетки. Нужна маркировка на упаковке для ЕАЭС: состав/назначение/производитель. Что обязательно?">Салфетки</div>
            <div class="chip" data-text="Майонез. Нужна маркировка/этикетка для ЕАЭС: что обязательно, какие нормы и ссылки.">Майонез</div>
          </div>
        </div>
      </div>

      <div class="messages" id="messages">
        <div class="sys">
          Пиши коротко или как получится — если данных мало, я уточню ровно то, что нужно. На ПК справа есть примеры.
        </div>
      </div>

      <div class="composerWrap" id="composer-wrap">
        <form class="composer" id="chat-form">
          <textarea id="chat-input" placeholder="Напиши вопрос… (например: «салфетки — маркировка для ЕАЭС»)" rows="1"></textarea>
          <button class="send" id="send-btn" type="submit" title="Отправить">➤</button>
        </form>
        <div class="foot">
          Ответы справочные — перед оформлением сверяйтесь с официальными текстами стандартов.
        </div>
        <div class="error" id="error"></div>

        <div class="paywall" id="paywall">
          <div class="paywallTitle">Лимит исчерпан</div>
          <div class="paywallText">Оформите премиум и задавайте вопросы без ограничений.</div>
          <button class="buy" id="buy-big" type="button">⭐ Премиум на месяц — 129 звёзд</button>
        </div>
      </div>
    </div>

    <!-- RIGHT PANEL (Desktop) -->
    <aside class="side">
      <div class="sideHeader">
        <div class="sideTitle">Инструмент инженера + умный чат</div>
        <div class="sideSub">Быстрые примеры, чтобы получать “нормальные” ответы с первого раза.</div>
      </div>
      <div class="sideBody">
        <div class="card">
          <div class="cardTitle">Как формулировать</div>
          <div class="cardText">
            1) Объект (что именно)<br>
            2) Цель (что нужно получить)<br>
            3) Контекст (ЕАЭС/РФ, тип документа, формат, материал и т.п.)
          </div>
        </div>

        <div class="card">
          <div class="cardTitle">Примеры</div>
          <div class="examples">
            <div class="ex" data-ex="Сборочный чертёж. Как оформлять спецификацию: порядок позиций, обозначения, что обязательно?">
              Сборочный → спецификация
            </div>
            <div class="ex" data-ex="Деталь, формат А4. Какие поля, рамка и основная надпись нужны? Дай алгоритм и ГОСТы.">
              Деталь → А4 рамка/штамп
            </div>
            <div class="ex" data-ex="Салфетки влажные в пластиковой упаковке. Маркировка для ЕАЭС: что обязательно, какие ТР/ГОСТ, что открыть в тексте.">
              Влажные салфетки → маркировка ЕАЭС
            </div>
            <div class="ex" data-ex="Пищевая продукция: как правильно написать состав и пищевую ценность на этикетке (ЕАЭС)? Какие обязательные элементы?">
              Еда → состав/пищевая ценность
            </div>
          </div>
        </div>

        <div class="card">
          <div class="cardTitle">Совет</div>
          <div class="cardText">
            Если вы пишете одно слово (“салфетки”), я уточню. Но если вы сразу дадите связку
            “салфетки — маркировка — ЕАЭС”, ответ будет сразу в цель.
          </div>
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
  const messagesEl = document.getElementById("messages");
  const formEl = document.getElementById("chat-form");
  const inputEl = document.getElementById("chat-input");
  const sendBtn = document.getElementById("send-btn");
  const errorEl = document.getElementById("error");
  const buySmallBtn = document.getElementById("buy-small");
  const buyBigBtn = document.getElementById("buy-big");
  const premiumBadgeEl = document.getElementById("premium-badge");
  const headerSubtitleEl = document.getElementById("header-subtitle");
  const limitLabelEl = document.getElementById("limit-label");
  const paywallEl = document.getElementById("paywall");

  const usedEl = document.getElementById("used");
  const limitEl = document.getElementById("limit");
  const remEl = document.getElementById("remaining");
  const progressInner = document.getElementById("limit-progress-inner");
  const limitWarningEl = document.getElementById("limit-warning");

  let telegramId = null;
  let messagesUsed = 0;
  let freeLimit = 3;
  let isPremium = false;
  let premiumUntil = null;
  let isSending = false;
  let isBuying = false;
  let limitReached = false;

  // === “Умная склейка” коротких ответов после уточняющего вопроса ===
  // если бэк вернул needs_clarification: true — запоминаем исходный запрос,
  // и следующий короткий ответ (типа "маркировка") клеим в "Салфетки — маркировка"
  let pendingClarify = null; // { base: "салфетки" }

  // мини-история на клиенте (чтобы бот отвечал более “разумно”)
  // отправляем 6 последних сообщений (user/assistant) на бэк, если он умеет принимать history
  const HISTORY_MAX = 6;
  const history = []; // {role, content}

  function pushHistory(role, content){
    history.push({ role, content });
    while (history.length > HISTORY_MAX) history.shift();
  }

  function scrollToBottom() { messagesEl.scrollTop = messagesEl.scrollHeight; }

  function appendMessage(role, content) {
    const row = document.createElement("div");
    row.className = "row " + role;

    const bubble = document.createElement("div");
    bubble.className = "bubble " + (role === "user" ? "user" : "assistant");
    bubble.textContent = content;

    row.appendChild(bubble);
    messagesEl.appendChild(row);
    scrollToBottom();
  }

  function appendTyping() {
    const row = document.createElement("div");
    row.className = "row assistant";
    row.id = "typing-row";

    const bubble = document.createElement("div");
    bubble.className = "bubble assistant";
    bubble.innerHTML = '<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>';

    row.appendChild(bubble);
    messagesEl.appendChild(row);
    scrollToBottom();
  }

  function removeTyping() {
    const row = document.getElementById("typing-row");
    if (row && row.parentNode) row.parentNode.removeChild(row);
  }

  function formatDateDDMMYY(iso) {
    const d = new Date(iso);
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = String(d.getFullYear()).slice(-2);
    return `${dd}.${mm}.${yy}`;
  }

  function updateUI() {
    if (isPremium && premiumUntil) {
      const dt = formatDateDDMMYY(premiumUntil);
      headerSubtitleEl.textContent = `Премиум до ${dt}`;
      limitLabelEl.textContent = "Премиум";
      premiumBadgeEl.style.display = "block";
      premiumBadgeEl.textContent = `Активен до ${dt}`;

      usedEl.textContent = "∞";
      limitEl.textContent = "∞";
      remEl.textContent = "∞";
      progressInner.style.width = "0%";
      limitWarningEl.textContent = "Без ограничений";
      buySmallBtn.style.display = "none";
      paywallEl.style.display = "none";

      inputEl.disabled = false;
      sendBtn.disabled = false;
      limitReached = false;
      return;
    }

    premiumBadgeEl.style.display = "none";
    headerSubtitleEl.textContent = "Эксперт по ЕСКД / ГОСТ / маркировке";
    limitLabelEl.textContent = "Бесплатные обращения";

    usedEl.textContent = messagesUsed;
    limitEl.textContent = freeLimit;

    const remaining = Math.max(0, freeLimit - messagesUsed);
    remEl.textContent = remaining;

    const percent = freeLimit > 0 ? Math.min(100, (messagesUsed / freeLimit) * 100) : 0;
    progressInner.style.width = percent + "%";

    limitReached = messagesUsed >= freeLimit;

    if (limitReached) {
      limitWarningEl.textContent = "Лимит исчерпан";
      buySmallBtn.style.display = "none";
      paywallEl.style.display = "block";
      inputEl.disabled = true;
      sendBtn.disabled = true;
    } else {
      limitWarningEl.textContent = `Осталось ${remaining} обращения`;
      buySmallBtn.style.display = "block";
      paywallEl.style.display = "none";
      inputEl.disabled = false;
      sendBtn.disabled = false;
    }
  }

  function initTelegramId() {
    try {
      const tg = window.Telegram && window.Telegram.WebApp;
      if (tg) {
        tg.ready();
        tg.expand();

        // подтягиваем Telegram theme params
        const p = tg.themeParams || {};
        if (p.bg_color) document.documentElement.style.setProperty('--bg', p.bg_color);
        if (p.text_color) document.documentElement.style.setProperty('--text', p.text_color);
        if (p.hint_color) document.documentElement.style.setProperty('--muted', p.hint_color);

        const user = tg.initDataUnsafe && tg.initDataUnsafe.user;
        telegramId = user?.id ? String(user.id) : ("anon-" + Math.random().toString(36).slice(2, 10));
      } else {
        // dev / browser mode
        let stored = null;
        try {
          stored = localStorage.getItem('eskd_dev_id');
          if (!stored) {
            stored = 'local-' + Math.random().toString(36).slice(2, 10);
            localStorage.setItem('eskd_dev_id', stored);
          }
        } catch(_) {
          stored = 'local-' + Math.random().toString(36).slice(2, 10);
        }
        telegramId = stored;
      }
    } catch (e) {
      console.error("Telegram init error", e);
      telegramId = "fallback-user";
    }
  }

  async function loadUserInfo() {
    if (!telegramId) return;
    try {
      const res = await fetch("/api/user", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ telegramId })
      });
      if (!res.ok) return;
      const data = await res.json();
      messagesUsed = data.messages_used ?? 0;
      freeLimit = data.free_limit ?? 3;
      isPremium = !!data.is_premium;
      premiumUntil = data.premium_until || null;
      updateUI();
    } catch (e) {
      console.error("loadUserInfo error", e);
    }
  }

  inputEl.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
  });

  function normalizeShortReply(text){
    const t = String(text || '').trim().toLowerCase();
    if (!t) return t;
    // маппинг “вместо цифры”
    if (t === 'маркировка') return 'маркировка';
    if (t === 'упаковка') return 'упаковка';
    if (t === 'состав') return 'состав';
    if (t === 'ескд') return 'ескд';
    return t;
  }

  function applyClarifyGlue(userText){
    if (!pendingClarify) return userText;

    const short = normalizeShortReply(userText);
    // если ответ короткий (одно слово/цифра) — приклеим к базовому запросу
    const isShort = short.length <= 18 && short.split(/\s+/).filter(Boolean).length <= 2;
    if (!isShort) { pendingClarify = null; return userText; }

    const glued = `${pendingClarify.base} — ${userText}`; // магия: “салфетки — маркировка”
    pendingClarify = null;
    return glued;
  }

  async function sendMessage(text) {
    errorEl.textContent = "";
    if (!text || isSending || (!isPremium && limitReached) || !telegramId) return;

    const finalText = applyClarifyGlue(text);

    appendMessage("user", text);
    pushHistory("user", finalText);

    inputEl.value = "";
    inputEl.style.height = 'auto';
    isSending = true;
    sendBtn.disabled = true;
    appendTyping();

    try {
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        // history — опционально, бэк может не использовать, но это задел на “разум”
        body: JSON.stringify({ telegramId, message: finalText, history })
      });

      removeTyping();

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        if (res.status === 403 && err.error && err.error.message === "limit_reached") {
          messagesUsed = err.messages_used ?? messagesUsed;
          freeLimit = err.free_limit ?? freeLimit;
          isPremium = !!err.is_premium;
          updateUI();
          errorEl.textContent = err.message || "Лимит исчерпан.";
          return;
        }
        errorEl.textContent = (err.error && err.error.message) || err.error || "Ошибка при обращении к серверу.";
        return;
      }

      const data = await res.json();
      if (data.ok === false) {
        errorEl.textContent = (data.error && data.error.message) || "Ошибка.";
        return;
      }

      messagesUsed = data.messages_used ?? messagesUsed;
      freeLimit = data.free_limit ?? freeLimit;
      isPremium = !!data.is_premium;
      premiumUntil = data.premium_until || premiumUntil;

      updateUI();

      const ans = data.answer || "Пустой ответ.";
      appendMessage("assistant", ans);
      pushHistory("assistant", ans);

      // если бэк сказал “нужно уточнение” — запомним ИСХОДНЫЙ базовый запрос (до клея)
      if (data.needs_clarification) {
        pendingClarify = { base: text.trim() || finalText.trim() };
      } else {
        pendingClarify = null;
      }
    } catch (err) {
      console.error("send error", err);
      removeTyping();
      errorEl.textContent = "Не удалось отправить запрос. Проверьте соединение.";
    } finally {
      isSending = false;
      if (!limitReached || isPremium) sendBtn.disabled = false;
    }
  }

  formEl.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = inputEl.value.trim();
    await sendMessage(text);
  });

  // chips
  document.getElementById("chips").addEventListener("click", (e) => {
    const chip = e.target.closest(".chip");
    if (!chip) return;
    const txt = chip.getAttribute("data-text");
    if (!txt) return;
    sendMessage(txt);
  });

  // right panel examples
  document.querySelectorAll(".ex").forEach(el => {
    el.addEventListener("click", () => {
      const txt = el.getAttribute("data-ex");
      if (txt) sendMessage(txt);
    });
  });

  async function handleBuyClick() {
    errorEl.textContent = "";
    if (!telegramId) { errorEl.textContent = "Не удалось определить Telegram ID."; return; }

    const tg = window.Telegram && window.Telegram.WebApp;
    if (!tg || !tg.openInvoice) {
      alert("Покупка доступна только внутри Telegram.");
      return;
    }

    if (isBuying) return;
    isBuying = true;
    buySmallBtn.disabled = true;
    buyBigBtn.disabled = true;

    try {
      const res = await fetch("/api/pay-stars", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ telegramId })
      });

      if (!res.ok) {
        errorEl.textContent = "Не удалось создать оплату.";
        return;
      }

      const data = await res.json();
      const invoiceUrl = data.invoice_url;
      if (!invoiceUrl) { errorEl.textContent = "Ошибка при создании счёта."; return; }

      tg.openInvoice(invoiceUrl, async (status) => {
        if (status === "paid") {
          errorEl.textContent = "Оплата прошла. Обновляю статус…";

          // несколько попыток, чтобы вебхук успел включить премиум
          let tries = 0;
          const timer = setInterval(async () => {
            tries++;
            await loadUserInfo();
            if (isPremium || tries >= 6) {
              clearInterval(timer);
              if (!isPremium) errorEl.textContent = "Оплата прошла, но статус обновляется. Откройте мини-апп заново через 10–20 секунд.";
              else errorEl.textContent = "";
            }
          }, 1100);
        } else if (status === "cancelled") {
          errorEl.textContent = "Оплата отменена.";
        } else if (status === "failed") {
          errorEl.textContent = "Оплата не прошла. Попробуйте ещё раз.";
        }
      });
    } catch (e) {
      console.error("buy error", e);
      errorEl.textContent = "Не удалось создать покупку. Проверьте интернет.";
    } finally {
      isBuying = false;
      buySmallBtn.disabled = false;
      buyBigBtn.disabled = false;
    }
  }

  buySmallBtn.addEventListener("click", handleBuyClick);
  buyBigBtn.addEventListener("click", handleBuyClick);

  // init
  initTelegramId();
  loadUserInfo();
  updateUI();
</script>
</body>
</html>
